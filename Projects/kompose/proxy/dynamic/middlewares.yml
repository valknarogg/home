# =================================================================
# Traefik Dynamic Middleware Configuration
# Location: /home/valknar/Projects/kompose/proxy/dynamic/middlewares.yml
# =================================================================
# This file defines reusable middleware chains for all Kompose services
# =================================================================

http:
  middlewares:
    # =================================================================
    # Base Middlewares
    # =================================================================
    
    # Compression
    compression:
      compress:
        excludedContentTypes:
          - "text/event-stream"
    
    # Security Headers
    security-headers:
      headers:
        frameDeny: true
        browserXssFilter: true
        contentTypeNosniff: true
        stsIncludeSubdomains: true
        stsPreload: true
        stsSeconds: 31536000
        forceSTSHeader: true
        customFrameOptionsValue: "SAMEORIGIN"
        customResponseHeaders:
          X-Robots-Tag: "none,noarchive,nosnippet,notranslate,noimageindex"
          server: ""
          X-Powered-By: ""
        contentSecurityPolicy: "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self'; frame-ancestors 'self'; base-uri 'self'; form-action 'self'"
    
    # Rate Limiting
    rate-limit:
      rateLimit:
        average: 100
        burst: 200
        period: 1s
    
    rate-limit-strict:
      rateLimit:
        average: 10
        burst: 20
        period: 1s
    
    # IP Whitelist (Internal Only)
    internal-only:
      ipWhiteList:
        sourceRange:
          - "127.0.0.1/32"
          - "10.0.0.0/8"
          - "172.16.0.0/12"
          - "192.168.0.0/16"
    
    # =================================================================
    # SSO Middleware Chains
    # =================================================================
    
    # Basic SSO (Forward Auth to OAuth2 Proxy)
    kompose-sso:
      forwardAuth:
        address: "http://auth_oauth2_proxy:4180/oauth2/auth"
        trustForwardHeader: true
        authResponseHeaders:
          - "X-Auth-Request-User"
          - "X-Auth-Request-Email"
          - "X-Auth-Request-Access-Token"
          - "X-Auth-Request-Groups"
    
    # SSO + Security + Compression
    sso-secure:
      chain:
        middlewares:
          - kompose-sso
          - security-headers
          - compression
    
    # SSO + Security + Rate Limiting
    sso-secure-limited:
      chain:
        middlewares:
          - kompose-sso
          - security-headers
          - rate-limit
          - compression
    
    # SSO + Security + Internal IP Restriction
    sso-internal-only:
      chain:
        middlewares:
          - internal-only
          - kompose-sso
          - security-headers
          - compression
    
    # =================================================================
    # Service-Specific Middlewares
    # =================================================================
    
    # Linkwarden
    linkwarden-middleware:
      chain:
        middlewares:
          - sso-secure
          - linkwarden-headers
    
    linkwarden-headers:
      headers:
        customRequestHeaders:
          X-Forwarded-Proto: "https"
        customResponseHeaders:
          X-Service: "Linkwarden"
    
    # Letterpress
    letterpress-middleware:
      chain:
        middlewares:
          - sso-secure
          - letterpress-headers
    
    letterpress-headers:
      headers:
        customResponseHeaders:
          X-Service: "Letterpress"
          Cache-Control: "public, max-age=3600"
    
    # Umami (Admin + Public Tracking)
    umami-admin:
      chain:
        middlewares:
          - kompose-sso
          - security-headers
          - compression
    
    umami-tracking:
      chain:
        middlewares:
          - umami-cors
          - rate-limit-strict
          - compression
    
    umami-cors:
      headers:
        accessControlAllowMethods:
          - "GET"
          - "POST"
          - "OPTIONS"
        accessControlAllowOriginList:
          - "*"
        accessControlAllowHeaders:
          - "Content-Type"
          - "Authorization"
          - "X-Umami-Website"
        accessControlMaxAge: 86400
    
    # Vaultwarden (Extra Security)
    vaultwarden-middleware:
      chain:
        middlewares:
          - sso-secure
          - vault-rate-limit
          - vault-headers
    
    vault-rate-limit:
      rateLimit:
        average: 10
        burst: 20
        period: 1s
    
    vault-headers:
      headers:
        customResponseHeaders:
          X-Service: "Vaultwarden"
          X-Content-Type-Options: "nosniff"
          Referrer-Policy: "no-referrer"
    
    # Monitoring Stack
    prometheus-auth:
      basicAuth:
        removeHeader: true
        # Users defined in watch stack .env
    
    grafana-middleware:
      chain:
        middlewares:
          - security-headers
          - compression
    
    # =================================================================
    # API Gateway Middlewares
    # =================================================================
    
    # API Rate Limiting
    api-rate-limit:
      rateLimit:
        average: 50
        burst: 100
        period: 1s
        sourceCriterion:
          requestHeaderName: "X-API-Key"
    
    # API Authentication (for external API access)
    api-auth:
      forwardAuth:
        address: "http://auth_oauth2_proxy:4180/oauth2/auth"
        trustForwardHeader: true
        authResponseHeaders:
          - "X-Auth-Request-User"
          - "X-Auth-Request-Email"
          - "X-API-Key"
    
    # CORS for API endpoints
    api-cors:
      headers:
        accessControlAllowOriginList:
          - "https://*.pivoine.art"
        accessControlAllowMethods:
          - "GET"
          - "POST"
          - "PUT"
          - "PATCH"
          - "DELETE"
          - "OPTIONS"
        accessControlAllowHeaders:
          - "Content-Type"
          - "Authorization"
          - "X-API-Key"
        accessControlExposeHeaders:
          - "X-Total-Count"
          - "X-Page"
        accessControlMaxAge: 86400
        accessControlAllowCredentials: true
    
    # =================================================================
    # Error Handling
    # =================================================================
    
    # Custom Error Pages
    error-pages:
      errors:
        status:
          - "400-599"
        service: error-service
        query: "/error-{status}.html"
    
    # Retry
    retry:
      retry:
        attempts: 3
        initialInterval: 100ms
    
    # Circuit Breaker
    circuit-breaker:
      circuitBreaker:
        expression: "NetworkErrorRatio() > 0.30"
    
    # =================================================================
    # Development & Testing
    # =================================================================
    
    # Disable Auth (for testing only - DO NOT USE IN PRODUCTION)
    # no-auth:
    #   chain:
    #     middlewares:
    #       - security-headers
    #       - compression
