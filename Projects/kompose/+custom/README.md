# Custom Stacks

This directory contains custom Docker Compose stacks generated by the `kompose generate` command.

## Overview

Custom stacks allow you to extend Kompose with your own services while maintaining:
- Consistent configuration patterns
- Integration with Traefik reverse proxy
- Centralized secrets management
- Automated testing
- Comprehensive documentation

## Getting Started

### Generate a New Stack

```bash
./kompose.sh generate myapp
```

This creates a complete stack structure:
```
+custom/myapp/
├── compose.yaml      # Docker Compose configuration
├── .env              # Environment variables
└── .gitignore        # Git ignore rules
```

### Start Your Stack

```bash
./kompose.sh up myapp
```

## Directory Structure

```
+custom/
├── README.md         # This file
├── myapp/           # Your custom stack
│   ├── compose.yaml
│   ├── .env
│   └── .gitignore
├── api-service/     # Another custom stack
│   ├── compose.yaml
│   └── .env
└── monitoring/      # Yet another stack
    ├── compose.yaml
    ├── .env
    └── config/
```

## Features

Each generated stack includes:

### 🐳 Docker Compose Configuration
- Pre-configured with Kompose network
- Traefik labels for automatic routing
- Health checks and restart policies
- Environment variable support

### 🔧 Environment Configuration
- Stack-specific .env file
- Integration with root domain configuration
- Automatic TRAEFIK_HOST generation
- Secrets support via root secrets.env

### 📝 Documentation
- Comprehensive README in `_docs/content/5.stacks/+custom/`
- Configuration examples
- Quick start guide
- Troubleshooting tips

### 🧪 Testing
- Automated test file in `__tests/generated/`
- Compose validation
- Environment checks
- Integration testing

## Management Commands

### List All Custom Stacks

```bash
./kompose.sh generate list
```

### Show Stack Information

```bash
./kompose.sh generate show myapp
```

### Delete a Stack

```bash
./kompose.sh generate delete myapp
```

### Standard Stack Operations

All standard Kompose commands work with custom stacks:

```bash
# Start/stop
./kompose.sh up myapp
./kompose.sh down myapp

# Status and logs
./kompose.sh status myapp
./kompose.sh logs myapp -f

# Restart
./kompose.sh restart myapp

# Execute commands
./kompose.sh exec myapp sh
```

## Configuration

### Domain Configuration

Add your subdomain to `domain.env`:

```bash
# In root domain.env
SUBDOMAIN_MYAPP=app
```

This generates `TRAEFIK_HOST_MYAPP` automatically.

### Secrets

Add secrets to root `secrets.env`:

```bash
# In root secrets.env
MYAPP_API_KEY=your-secret-key
MYAPP_DATABASE_PASSWORD=your-password
```

### Environment Variables

Configure in stack's `.env` file:

```bash
# In +custom/myapp/.env
COMPOSE_PROJECT_NAME=myapp
DOCKER_IMAGE=your-image:latest
APP_PORT=80
TRAEFIK_HOST=${TRAEFIK_HOST_MYAPP}
```

## Best Practices

### Naming Conventions

- Use lowercase letters, numbers, and hyphens
- Keep names short and descriptive
- Examples: `webapp`, `api-gateway`, `monitoring-stack`

### File Organization

```
+custom/myapp/
├── compose.yaml          # Main configuration
├── .env                  # Public configuration
├── .gitignore           # Version control
├── config/              # Configuration files
│   └── app.conf
├── scripts/             # Helper scripts
│   └── init.sh
└── data/                # Local data (gitignored)
```

### Version Control

Add to `.gitignore`:
```
+custom/*/data/
+custom/*/.env.generated
+custom/*/.env.local
+custom/*/logs/
```

### Health Checks

Always include health checks:

```yaml
healthcheck:
  test: ["CMD-SHELL", "wget --spider -q http://localhost:80/health || exit 1"]
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 30s
```

### Resource Limits

Set appropriate limits:

```yaml
deploy:
  resources:
    limits:
      cpus: '2'
      memory: 2G
```

## Integration

### With Core Services

Access database, Redis, and MQTT:

```yaml
services:
  myapp:
    environment:
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT}
      REDIS_HOST: core-redis
      MQTT_HOST: core-mqtt
    depends_on:
      core-postgres:
        condition: service_healthy
```

### With Profiles

Add to profiles for environment management:

```bash
./kompose.sh profile create production
# Add myapp to profile configuration
./kompose.sh profile up
```

### With CI/CD

Automated deployment via Gitea Actions:

```yaml
# In .gitea/workflows/deploy.yml
- name: Deploy Custom Stack
  run: |
    ./kompose.sh pull myapp
    ./kompose.sh up myapp
```

## Examples

### Simple Web Application

```bash
./kompose.sh generate webapp
vim +custom/webapp/.env  # Configure
./kompose.sh up webapp
```

### API with Database

```bash
./kompose.sh generate api
vim +custom/api/compose.yaml  # Add DB connection
./kompose.sh db exec -d postgres "CREATE DATABASE api;"
./kompose.sh up api
```

### Multi-Service Stack

```bash
./kompose.sh generate platform
vim +custom/platform/compose.yaml  # Add multiple services
./kompose.sh up platform
```

## Troubleshooting

### Stack Won't Start

```bash
# Check compose validity
cd +custom/myapp
docker compose config

# Check logs
./kompose.sh logs myapp

# Verify environment
cat .env
```

### Traefik Routing Issues

```bash
# Check labels
docker inspect myapp_app | grep traefik

# Verify Traefik
./kompose.sh status proxy
docker logs proxy-traefik
```

### Network Issues

```bash
# Verify network exists
docker network ls | grep kompose

# Create if missing
docker network create kompose

# Check connectivity
docker exec myapp_app ping core-postgres
```

## Documentation

- **Full Guide:** `_docs/content/3.guide/generator.md`
- **Stack Docs:** `_docs/content/5.stacks/+custom/`
- **Main README:** `README.md`

## See Also

- [Generator Command Documentation](/guide/generator)
- [Stack Configuration Reference](/reference/stack-configuration)
- [Custom Stacks Guide](/guide/custom-stacks)
- [Environment Management](/guide/environment)

---

**Location:** `+custom/`  
**Generator:** `kompose-generate.sh`  
**Command:** `./kompose.sh generate <name>`
