# Environment File Generation Fix

## Problem Statement

The kompose stack management system has a disconnect between environment variable management and Docker Compose execution:

1. **Environment Loading**: The `load_stack_env()` function successfully loads and exports variables from:
   - Root `.env` file
   - `domain.env` file  
   - `secrets.env` file

2. **Compose Execution**: The `run_compose()` function in `kompose-stack.sh` expects `.env.generated` files:
   ```bash
   if [ -f ".env.generated" ]; then
       docker compose --env-file .env.generated "$@"
   else
       log_error "Failed to generate environment file for stack: $stack"
       return 1
   fi
   ```

3. **Missing Link**: The `generate_stack_env_file()` function was deprecated and no longer creates the required `.env.generated` files.

## Impact

All compose.yaml files in subdirectories cannot access the root environment variables:
- `./auth/compose.yaml`
- `./code/compose.yaml`
- `./_docs/compose.yaml`
- `./kmps/compose.yaml`
- `./messaging/compose.yaml`
- `./track/compose.yaml`
- `./vpn/compose.yaml`
- `./chain/compose.yaml`
- `./core/compose.yaml`
- `./home/compose.yaml`
- `./link/compose.yaml`
- `./proxy/compose.yaml`
- `./vault/compose.yaml`
- `./watch/compose.yaml`

## Solution

Implement a functional `generate_stack_env_file()` function that creates `.env.generated` files containing all necessary environment variables for each stack.

### Key Requirements

1. **Stack-Specific Variables**: Include all variables with the stack prefix (e.g., `CORE_*`, `AUTH_*`)
2. **Generic Mapped Variables**: Include unprefixed versions (e.g., `POSTGRES_IMAGE` from `CORE_POSTGRES_IMAGE`)
3. **Common Shared Variables**: Include all common variables like `NETWORK_NAME`, `TIMEZONE`, `DB_HOST`, etc.
4. **Traefik Hosts**: Include all `TRAEFIK_HOST_*` variables
5. **Service Aliases**: Include backwards compatibility aliases
6. **Secrets**: Include sensitive variables from `secrets.env`

### Implementation

The updated `generate_stack_env_file()` function will:

1. Determine the stack directory (built-in or custom)
2. Create a temporary file for safe atomic writes
3. Write all relevant environment variables to the file
4. Move the file to `.env.generated` in the stack directory
5. Set secure permissions (600) since the file contains secrets

### File Structure

Each `.env.generated` file will contain:

```
# Auto-generated environment file for {stack} stack
# Generated at: {timestamp}
# DO NOT EDIT - This file is automatically generated from root .env

# Stack-specific variables with prefix
STACK_VAR1=value1
STACK_VAR2=value2

# Generic mapped variables without prefix  
VAR1=value1
VAR2=value2

# Common shared variables
COMPOSE_PROJECT_NAME=stack
NETWORK_NAME=kompose
TIMEZONE=Europe/Amsterdam
...

# Database configuration
DB_HOST=core-postgres
DB_PASSWORD=secret
...

# All other common variables
# Traefik hosts
# Service aliases
```

## Testing

After implementation, verify by:

1. Running `./kompose.sh core env` to see generated variables
2. Checking for `.env.generated` files in stack directories
3. Running `docker compose config` in a stack directory to verify variable substitution
4. Starting a stack with `./kompose.sh core up` to confirm services start correctly

## Security Considerations

The `.env.generated` files contain sensitive information (passwords, tokens, keys) from `secrets.env`, therefore:

1. Files are created with 600 permissions (owner read/write only)
2. Files should be in `.gitignore` to prevent accidental commits
3. Files are regenerated on each stack operation to ensure freshness
4. Files are named `.env.generated` to clearly indicate they are auto-generated artifacts

## Backward Compatibility

This solution maintains compatibility with:
- Existing stack directories and compose files
- Current variable naming conventions
- The kompose.sh CLI interface
- All existing stack management functions
