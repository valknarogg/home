# Custom PostgreSQL queries for enhanced monitoring

pg_replication:
  query: "SELECT CASE WHEN NOT pg_is_in_recovery() THEN 0 ELSE GREATEST (0, EXTRACT(EPOCH FROM (now() - pg_last_xact_replay_timestamp()))) END AS lag"
  master: true
  metrics:
    - lag:
        usage: "GAUGE"
        description: "Replication lag behind master in seconds"

pg_database:
  query: |
    SELECT
      pg_database.datname,
      pg_database_size(pg_database.datname) as size_bytes,
      pg_stat_get_db_numbackends(pg_database.oid) as numbackends
    FROM pg_database
  metrics:
    - datname:
        usage: "LABEL"
        description: "Name of the database"
    - size_bytes:
        usage: "GAUGE"
        description: "Disk space used by the database"
    - numbackends:
        usage: "GAUGE"
        description: "Number of backends currently connected to this database"

pg_stat_statements:
  query: |
    SELECT
      queryid,
      query,
      calls,
      total_time,
      min_time,
      max_time,
      mean_time,
      stddev_time,
      rows
    FROM pg_stat_statements
    ORDER BY mean_time DESC
    LIMIT 10
  master: true
  metrics:
    - queryid:
        usage: "LABEL"
        description: "Query ID"
    - query:
        usage: "LABEL"
        description: "Query text"
    - calls:
        usage: "COUNTER"
        description: "Number of times executed"
    - total_time:
        usage: "COUNTER"
        description: "Total time spent in the statement"
    - min_time:
        usage: "GAUGE"
        description: "Minimum time spent in the statement"
    - max_time:
        usage: "GAUGE"
        description: "Maximum time spent in the statement"
    - mean_time:
        usage: "GAUGE"
        description: "Mean time spent in the statement"
    - stddev_time:
        usage: "GAUGE"
        description: "Standard deviation of time spent in the statement"
    - rows:
        usage: "COUNTER"
        description: "Total number of rows retrieved or affected by the statement"

pg_locks:
  query: |
    SELECT
      pg_database.datname,
      tmp.mode,
      COALESCE(count, 0) as count
    FROM
      (VALUES ('accesssharelock'),
              ('rowsharelock'),
              ('rowexclusivelock'),
              ('shareupdateexclusivelock'),
              ('sharelock'),
              ('sharerowexclusivelock'),
              ('exclusivelock'),
              ('accessexclusivelock')) AS tmp(mode)
      CROSS JOIN pg_database
      LEFT JOIN (
        SELECT database, lower(mode) AS mode, count(*) AS count
        FROM pg_locks
        WHERE database IS NOT NULL
        GROUP BY database, lower(mode)
      ) AS tmp2 ON tmp.mode = tmp2.mode AND pg_database.oid = tmp2.database
    ORDER BY 1
  metrics:
    - datname:
        usage: "LABEL"
        description: "Name of the database"
    - mode:
        usage: "LABEL"
        description: "Type of lock"
    - count:
        usage: "GAUGE"
        description: "Number of locks"

pg_table_bloat:
  query: |
    SELECT
      schemaname,
      tablename,
      pg_total_relation_size(schemaname||'.'||tablename) AS size_bytes
    FROM pg_tables
    WHERE schemaname NOT IN ('pg_catalog', 'information_schema')
    ORDER BY size_bytes DESC
    LIMIT 20
  metrics:
    - schemaname:
        usage: "LABEL"
        description: "Schema name"
    - tablename:
        usage: "LABEL"
        description: "Table name"
    - size_bytes:
        usage: "GAUGE"
        description: "Total size of the table including indexes"

pg_slow_queries:
  query: |
    SELECT
      pid,
      usename,
      application_name,
      client_addr,
      state,
      EXTRACT(EPOCH FROM (now() - query_start)) AS duration_seconds
    FROM pg_stat_activity
    WHERE state != 'idle'
      AND query_start IS NOT NULL
      AND EXTRACT(EPOCH FROM (now() - query_start)) > 5
    ORDER BY duration_seconds DESC
  metrics:
    - pid:
        usage: "LABEL"
        description: "Process ID"
    - usename:
        usage: "LABEL"
        description: "Database user"
    - application_name:
        usage: "LABEL"
        description: "Application name"
    - client_addr:
        usage: "LABEL"
        description: "Client IP address"
    - state:
        usage: "LABEL"
        description: "Current state"
    - duration_seconds:
        usage: "GAUGE"
        description: "Query duration in seconds"
