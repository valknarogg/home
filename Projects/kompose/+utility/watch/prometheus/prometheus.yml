# Prometheus Configuration for Kompose.sh Monitoring Stack
# This configuration scrapes metrics from all core services and integrations

global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    cluster: 'kompose'
    environment: 'production'

# Alertmanager configuration
alerting:
  alertmanagers:
    - static_configs:
        - targets:
            - 'watch_alertmanager:9093'

# Load rules once and periodically evaluate them
rule_files:
  - '/etc/prometheus/rules/*.yml'

# Scrape configurations
scrape_configs:
  # Prometheus itself
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
        labels:
          service: 'prometheus'
          stack: 'watch'

  # Grafana
  - job_name: 'grafana'
    static_configs:
      - targets: ['watch_grafana:3000']
        labels:
          service: 'grafana'
          stack: 'watch'

  # OpenTelemetry Collector
  - job_name: 'otel-collector'
    static_configs:
      - targets: ['watch_otel:8888']
        labels:
          service: 'otel-collector'
          stack: 'watch'

  # PostgreSQL Exporter - Core Database
  - job_name: 'postgresql'
    static_configs:
      - targets: ['watch_postgres_exporter:9187']
        labels:
          service: 'postgresql'
          stack: 'core'
          database: 'postgres'

  # Redis Exporter - Core Cache
  - job_name: 'redis'
    static_configs:
      - targets: ['watch_redis_exporter:9121']
        labels:
          service: 'redis'
          stack: 'core'
          cache: 'redis'

  # MQTT Exporter - Core Message Broker
  - job_name: 'mqtt'
    static_configs:
      - targets: ['watch_mqtt_exporter:9000']
        labels:
          service: 'mqtt'
          stack: 'core'
          broker: 'mosquitto'

  # cAdvisor - Docker Container Metrics
  - job_name: 'cadvisor'
    static_configs:
      - targets: ['watch_cadvisor:8080']
        labels:
          service: 'cadvisor'
          stack: 'watch'
          type: 'container-metrics'

  # Node Exporter - Host System Metrics
  - job_name: 'node'
    static_configs:
      - targets: ['localhost:9100']
        labels:
          service: 'node-exporter'
          stack: 'watch'
          type: 'host-metrics'

  # Traefik - Reverse Proxy Metrics
  - job_name: 'traefik'
    static_configs:
      - targets: ['proxy_app:8080']
        labels:
          service: 'traefik'
          stack: 'proxy'
          type: 'reverse-proxy'
    metrics_path: '/metrics'

  # Home Assistant - Smart Home Platform
  - job_name: 'homeassistant'
    metrics_path: '/api/prometheus'
    bearer_token: 'YOUR_LONG_LIVED_ACCESS_TOKEN'
    static_configs:
      - targets: ['home_homeassistant:8123']
        labels:
          service: 'homeassistant'
          stack: 'home'
          type: 'smart-home'

  # Umami - Web Analytics (Custom metrics endpoint if available)
  - job_name: 'umami'
    static_configs:
      - targets: ['track_app:3000']
        labels:
          service: 'umami'
          stack: 'track'
          type: 'analytics'
    scrape_interval: 60s
    metrics_path: '/api/metrics'
    # Note: Umami doesn't have native Prometheus metrics
    # Consider using blackbox exporter to monitor availability

  # Blackbox Exporter - Endpoint Monitoring
  - job_name: 'blackbox'
    metrics_path: /probe
    params:
      module: [http_2xx]
    static_configs:
      - targets:
          # Core Services
          - http://core-postgres:5432
          - http://core-redis:6379
          - http://core-mqtt:1883
          # Utility Services
          - http://track_app:3000
          # Home Services
          - http://home_homeassistant:8123
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: watch_blackbox_exporter:9115

  # Blackbox Exporter - HTTPS Endpoints
  - job_name: 'blackbox-https'
    metrics_path: /probe
    params:
      module: [http_2xx]
    static_configs:
      - targets:
          - https://grafana.localhost
          - https://prometheus.localhost
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: watch_blackbox_exporter:9115

  # MQTT Topics Monitoring
  - job_name: 'mqtt-topics'
    static_configs:
      - targets: ['watch_mqtt_exporter:9000']
        labels:
          service: 'mqtt-topics'
          stack: 'core'
          type: 'mqtt-data'
    scrape_interval: 30s

  # Self-monitoring - Alertmanager
  - job_name: 'alertmanager'
    static_configs:
      - targets: ['watch_alertmanager:9093']
        labels:
          service: 'alertmanager'
          stack: 'watch'
